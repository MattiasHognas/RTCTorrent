var RtcTorrent;(function(n){"use strict";var t=function(){function n(n,t,i,r,u){this.torrent=n,this.reader=t,this.fullPath=i,this.size=r,this.pieces=u,this.index()}return n.prototype.index=function(){var n=this;console.log(n.torrent.fs.root.toURL()),n.torrent.fs.root.getFile(n.fullPath,{create:!0,exclusive:!1},function(t){t.file(function(i){t.createWriter(function(t){t.onwriteend=function(){t.onwriteend=null,n.loadPieces(i)},t.seek(i.size),i.size<n.size?t.truncate(n.size):n.loadPieces(i)},function(n){console.log("error",n)})},function(n){console.log("error",n)})})},n.prototype.loadPieces=function(n){var t=this,i=new FileReader;i.onloadend=function(){var e,u,n;if(i.readyState==2)for(e=i.result,u=1,n=0;n<t.pieces.length;n++){var r=u-1,f=r+t.pieces[n].size()-1,o=e[r];o===undefined?t.requestPiece(r,f):t.announcePiece(r,f),u=f+2}},i.readAsArrayBuffer(n)},n.prototype.announcePiece=function(n,t){console.log("announcePiece",n,t)},n.prototype.requestPiece=function(n,t){console.log("requestPiece",n,t)},n.prototype.readPiece=function(n,t,i){var r=this;r.torrent.fs.root.getFile(r.fullPath,{create:!0,exclusive:!1},function(r){r.file(function(r){var u=new FileReader,f;u.onloadend=function(){u.readyState==2&&i(u.result)},f=r.slice(n,t+1),u.readAsArrayBuffer(f)},function(n){console.log("error",n)})})},n.prototype.writePiece=function(n,t){var i=ko.utils.arrayFirst(this.pieces,function(n){return n.startByte==n.startByte}),u,r;i!=null&&(u=this.torrent.client.configuration.crypto.hex_sha1(this.arraybuffer2string(n)),u!=i.hash()?this.requestPiece(i.startByte(),i.size()+i.startByte()):(r=this,r.torrent.fs.root.getFile(r.fullPath,{create:!0,exclusive:!1},function(i){r.write(n,t,i)},function(n){console.log("error",n)})))},n.prototype.write=function(n,t,i){var f=this,e=i.size,u=new this.torrent.client.configuration.blobBuilder,r;u.append(n),r=i.createWriter(),r.onwriteend=function(){r.onwriteend=null,f.announcePiece(t,t+n.byteLength)},r.seek(t),r.write(u.getBlob())},n.prototype.arraybuffer2string=function(n){return String.fromCharCode.apply(null,new Uint16Array(n))},n.prototype.string2arraybuffer=function(n){for(var i=new ArrayBuffer(n.length*2),u=new Uint16Array(i),t=0,r=n.length;t<r;t++)u[t]=n.charCodeAt(t);return i},n}();n.FileContent=t})(RtcTorrent||(RtcTorrent={}))